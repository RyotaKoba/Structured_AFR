Bootstrap: docker
From: nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04

%post
    # システムパッケージの更新
    apt-get update && apt-get upgrade -y
    
    # 基本的なシステムツールのインストール
    apt-get install -y \
        build-essential \
        cmake \
        git \
        curl \
        wget \
        vim \
        htop \
        tree \
        unzip \
        software-properties-common \
        ca-certificates \
        gnupg \
        lsb-release
    
    # Python 3.12のインストール（Ubuntu 24.04デフォルト）
    apt-get install -y \
        python3 \
        python3-dev \
        python3-venv \
        curl
    
    # pipを手動でインストール
    curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    python3 get-pip.py --break-system-packages
    rm get-pip.py
    
    # setuptools, wheelのインストール
    python3 -m pip install --break-system-packages setuptools wheel
    
    # PyTorchのインストール（CUDA 12.1版）
    python3 -m pip install --break-system-packages torch torchvision torchaudio
    
    # その他の深層学習パッケージ
    python3 -m pip install --break-system-packages \
        transformers \
        accelerate \
        datasets \
        scikit-learn \
        numpy \
        scipy \
        matplotlib \
        seaborn \
        pandas \
        jupyter \
        notebook \
        ipython \
        tqdm \
        tensorboard \
        wandb \
        optuna \
        hydra-core \
        omegaconf
    
    # bitsandbytesのインストール
    python3 -m pip install --break-system-packages -U bitsandbytes==0.45.5
    
    # モデル枝刈り用のパッケージ
    python3 -m pip install --break-system-packages \
        torch-pruning \
        neural-compressor
    
    # クリーンアップ
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    
    # Python3をデフォルトのpythonコマンドに設定
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1

%environment
    # CUDA環境変数
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
    
    # Python環境変数
    export PYTHONPATH=/usr/local/lib/python3.12/site-packages:$PYTHONPATH
    export PYTHON_VERSION=3.12
    
    # PyTorch設定
    export TORCH_CUDA_ARCH_LIST="6.0;6.1;7.0;7.5;8.0;8.6;8.9;9.0"
    
    # その他の環境変数
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Asia/Tokyo

%runscript
    # デフォルトでPythonを起動
    python "$@"

%labels
    Author your-name@example.com
    Version 1.0
    Description CUDA 12.8.1 + cuDNN + Python 3.12 environment for model pruning
    Usage singularity run model_pruning.sif your_script.py

%help
    このコンテナは深層学習モデルの枝刈り（Pruning）作業用に設計されています。
    
    含まれている主要なパッケージ:
    - CUDA 12.8.1 + cuDNN
    - Python 3.12 (Ubuntu 24.04デフォルト)
    - PyTorch (CUDA対応)
    - Transformers
    - torch-pruning
    - neural-compressor
    - その他の機械学習ライブラリ
    
    使用例:
    singularity run model_pruning.sif pruning_script.py
    singularity shell model_pruning.sif
    singularity exec model_pruning.sif python train.py